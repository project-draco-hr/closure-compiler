{
  Preconditions.checkArgument(!ignoreJsdoc || jsdoc == null);
  Preconditions.checkArgument(!ignoreJsdoc || funNode.isFunction());
  boolean ignoreFunNode=!funNode.isFunction();
  FunctionTypeBuilder builder=new FunctionTypeBuilder();
  Node params=ignoreFunNode ? null : funNode.getFirstChild().getNext();
  ImmutableList<String> typeParameters=null;
  Node parent=funNode.getParent();
  if (jsdoc != null) {
    typeParameters=jsdoc.getTemplateTypeNames();
    if (!typeParameters.isEmpty()) {
      if (parent.isSetterDef() || parent.isGetterDef()) {
        ignoreJsdoc=true;
        jsdoc=null;
        warn("@template can't be used with getters/setters",funNode);
      }
 else {
        builder.addTypeParameters(typeParameters);
      }
    }
  }
  ParamIterator iterator=new ParamIterator(params,jsdoc);
  while (iterator.hasNext()) {
    String pname=iterator.nextString();
    Node param=iterator.getNode();
    JSType inlineParamType=(ignoreJsdoc || ignoreFunNode) ? null : getNodeTypeDeclaration(param.getJSDocInfo(),ownerType,registry,typeParameters);
    boolean isRequired=true, isRestFormals=false;
    JSTypeExpression texp=jsdoc == null ? null : jsdoc.getParameterType(pname);
    Node jsdocNode=texp == null ? null : texp.getRoot();
    if (param != null) {
      if (convention.isOptionalParameter(param)) {
        isRequired=false;
      }
 else       if (convention.isVarArgsParameter(param)) {
        isRequired=false;
        isRestFormals=true;
      }
    }
    JSType fnParamType=null;
    if (jsdocNode != null) {
      if (jsdocNode.getType() == Token.EQUALS) {
        isRequired=false;
        jsdocNode=jsdocNode.getFirstChild();
      }
 else       if (jsdocNode.getType() == Token.ELLIPSIS) {
        isRequired=false;
        isRestFormals=true;
        jsdocNode=jsdocNode.getFirstChild();
      }
      fnParamType=getTypeFromNode(jsdocNode,ownerType,registry,typeParameters);
    }
    if (inlineParamType != null) {
      builder.addReqFormal(inlineParamType);
      if (fnParamType != null) {
        warn("Found two JsDoc comments for formal parameter " + pname,param);
      }
    }
 else     if (isRequired) {
      builder.addReqFormal(fnParamType);
    }
 else     if (isRestFormals) {
      builder.addRestFormals(fnParamType == null ? JSType.UNKNOWN : fnParamType);
    }
 else {
      builder.addOptFormal(fnParamType);
    }
  }
  JSDocInfo inlineRetJsdoc=ignoreJsdoc ? null : funNode.getFirstChild().getJSDocInfo();
  JSTypeExpression retTypeExp=jsdoc == null ? null : jsdoc.getReturnType();
  if (parent.isSetterDef()) {
    inlineRetJsdoc=ignoreJsdoc ? null : funNode.getLastChild().getJSDocInfo();
    if (retTypeExp != null || inlineRetJsdoc != null) {
      warn("Cannot declare a return type on a setter",funNode);
    }
    builder.addRetType(JSType.UNDEFINED);
  }
 else   if (inlineRetJsdoc != null) {
    builder.addRetType(getNodeTypeDeclaration(inlineRetJsdoc,ownerType,registry,typeParameters));
    if (retTypeExp != null) {
      warn("Found two JsDoc comments for the return type",funNode);
    }
  }
 else {
    builder.addRetType(getTypeFromJSTypeExpression(retTypeExp,ownerType,registry,typeParameters));
  }
  return builder;
}
