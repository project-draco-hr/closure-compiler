{
  Preconditions.checkArgument(!ignoreJsdoc || jsdoc == null);
  Preconditions.checkArgument(!ignoreJsdoc || funNode.isFunction());
  ImmutableList.Builder<String> typeParamsBuilder=new ImmutableList.Builder<>();
  ;
  ImmutableList<String> typeParameters=ImmutableList.of();
  Node parent=funNode.getParent();
  if (jsdoc != null) {
    typeParamsBuilder.addAll(jsdoc.getTemplateTypeNames());
    typeParamsBuilder.addAll(jsdoc.getTypeTransformations().keySet());
    typeParameters=typeParamsBuilder.build();
    if (!typeParameters.isEmpty()) {
      if (parent.isSetterDef() || parent.isGetterDef()) {
        ignoreJsdoc=true;
        jsdoc=null;
        warn("@template can't be used with getters/setters",funNode);
      }
 else {
        builder.addTypeParameters(typeParameters);
      }
    }
  }
  if (ownerType != null) {
    typeParamsBuilder.addAll(ownerType.getTypeParameters());
    typeParameters=typeParamsBuilder.build();
  }
  fillInFormalParameterTypes(jsdoc,funNode,typeParameters,registry,builder,ignoreJsdoc);
  fillInReturnType(jsdoc,funNode,parent,typeParameters,registry,builder,ignoreJsdoc);
  if (jsdoc == null) {
    return builder.buildDeclaration();
  }
  NominalType parentClass=getMaybeParentClass(jsdoc,functionName,funNode,typeParameters,registry);
  ImmutableSet<NominalType> implementedIntfs=getImplementedInterfaces(jsdoc,registry,typeParameters);
  if (constructorType == null && jsdoc.isConstructorOrInterface()) {
    return builder.buildDeclaration();
  }
 else   if (jsdoc.isConstructor()) {
    handleConstructorAnnotation(functionName,funNode,constructorType,parentClass,implementedIntfs,registry,builder);
  }
 else   if (jsdoc.isInterface()) {
    handleInterfaceAnnotation(jsdoc,functionName,funNode,constructorType,implementedIntfs,typeParameters,registry,builder);
  }
 else   if (!implementedIntfs.isEmpty()) {
    warnings.add(JSError.make(funNode,IMPLEMENTS_WITHOUT_CONSTRUCTOR,functionName));
  }
  if (jsdoc.hasThisType() && ownerType == null) {
    Node thisRoot=jsdoc.getThisType().getRoot();
    Preconditions.checkState(thisRoot.getType() == Token.BANG);
    JSType t=getThisOrNewType(thisRoot.getFirstChild(),registry,typeParameters);
    builder.addReceiverType(t == null ? JSType.TOP_OBJECT : t);
  }
  return builder.buildDeclaration();
}
