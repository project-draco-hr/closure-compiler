{
  Scope s=var.getScope();
  Collection<Node> references=varToNameUsage.get(var);
  varsByFrequency.remove(original);
  varsByFrequency.remove(toShadow);
  original.count-=references.size();
  toShadow.count+=references.size();
  varsByFrequency.add(original);
  varsByFrequency.add(toShadow);
  Var shadowed=s.getVar(toShadow.oldName);
  if (shadowed != null) {
    for (Scope curScope=s; curScope != shadowed.scope; curScope=curScope.getParent()) {
      scopeUpRefMap.put(curScope.getRootNode(),toShadow.oldName);
    }
  }
  for (  Node n : references) {
    n.setString(toShadow.oldName);
    Node cur=n;
    while (cur != s.getRootNode()) {
      cur=cur.getParent();
      if (NodeUtil.isFunction(cur)) {
        scopeUpRefMap.put(cur,toShadow.oldName);
      }
    }
  }
}
