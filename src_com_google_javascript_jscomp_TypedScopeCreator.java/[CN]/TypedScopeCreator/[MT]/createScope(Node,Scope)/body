{
  Scope newScope=null;
  AbstractScopeBuilder scopeBuilder=null;
  if (parent == null) {
    JSType globalThis=typeRegistry.getNativeObjectType(JSTypeNative.GLOBAL_THIS);
    root.setJSType(globalThis);
    root.getFirstChild().setJSType(globalThis);
    root.getLastChild().setJSType(globalThis);
    (new FirstOrderFunctionAnalyzer(compiler,functionAnalysisResults)).process(root.getFirstChild(),root.getLastChild());
    newScope=createInitialScope(root);
    GlobalScopeBuilder globalScopeBuilder=new GlobalScopeBuilder(newScope);
    scopeBuilder=globalScopeBuilder;
    NodeTraversal.traverse(compiler,root,scopeBuilder);
  }
 else {
    newScope=new Scope(parent,root);
    LocalScopeBuilder localScopeBuilder=new LocalScopeBuilder(newScope);
    scopeBuilder=localScopeBuilder;
    localScopeBuilder.build();
  }
  scopeBuilder.resolveStubDeclarations();
  scopeBuilder.resolveTypes();
  for (  Node functionNode : scopeBuilder.nonExternFunctions) {
    JSType type=functionNode.getJSType();
    if (type != null && type.isFunctionType()) {
      FunctionType fnType=type.toMaybeFunctionType();
      JSType fnThisType=fnType.getTypeOfThis();
      if (!fnThisType.isUnknownType()) {
        NodeTraversal.traverse(compiler,functionNode.getLastChild(),scopeBuilder.new CollectProperties(fnThisType));
      }
    }
  }
  if (parent == null) {
    codingConvention.defineDelegateProxyPrototypeProperties(typeRegistry,newScope,delegateProxyPrototypes,delegateCallingConventions);
  }
  return newScope;
}
