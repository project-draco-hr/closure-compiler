{
  Scope newScope=null;
  if (parent == null) {
    newScope=createInitialScope(root);
    GlobalScopeBuilder scopeBuilder=new GlobalScopeBuilder(newScope);
    NodeTraversal.traverse(compiler,root,scopeBuilder);
    scopeBuilder.resolveStubDeclarations();
    scopeBuilder.resolveTypes();
    for (    Node functionNode : scopeBuilder.nonExternFunctions) {
      JSType type=functionNode.getJSType();
      if (type != null && type instanceof FunctionType) {
        FunctionType fnType=(FunctionType)type;
        ObjectType fnThisType=fnType.getTypeOfThis();
        if (!fnThisType.isUnknownType()) {
          NodeTraversal.traverse(compiler,functionNode.getLastChild(),scopeBuilder.new CollectProperties(fnThisType));
        }
      }
    }
    codingConvention.defineDelegateProxyPrototypeProperties(typeRegistry,newScope,delegateProxyPrototypes);
  }
 else {
    newScope=new Scope(parent,root);
    LocalScopeBuilder scopeBuilder=new LocalScopeBuilder(newScope);
    scopeBuilder.build();
    scopeBuilder.resolveTypes();
  }
  return newScope;
}
