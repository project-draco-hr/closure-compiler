{
  Preconditions.checkArgument(!variableName.isEmpty());
  boolean isGlobalVar=n.isName() && scope.isGlobal();
  boolean shouldDeclareOnGlobalThis=isGlobalVar && (parent.isVar() || parent.isFunction());
  Scope scopeToDeclareIn=scope;
  if (n.isGetProp() && !scope.isGlobal() && isQnameRootedInGlobalScope(n)) {
    Scope globalScope=scope.getGlobalScope();
    if (!globalScope.isDeclared(variableName,false)) {
      scopeToDeclareIn=scope.getGlobalScope();
    }
  }
  boolean isExtern=n.isFromExterns();
  Var newVar=null;
  CompilerInput input=compiler.getInput(inputId);
  if (scopeToDeclareIn.isDeclared(variableName,false)) {
    Var oldVar=scopeToDeclareIn.getVar(variableName);
    newVar=validator.expectUndeclaredVariable(sourceName,input,n,parent,oldVar,variableName,type);
  }
 else {
    if (!inferred) {
      setDeferredType(n,type);
    }
    newVar=scopeToDeclareIn.declare(variableName,n,type,input,inferred);
    if (type instanceof EnumType) {
      Node initialValue=newVar.getInitialValue();
      boolean isValidValue=initialValue != null && (initialValue.isObjectLit() || initialValue.isQualifiedName());
      if (!isValidValue) {
        compiler.report(JSError.make(sourceName,n,ENUM_INITIALIZER));
      }
    }
  }
  FunctionType fnType=JSType.toMaybeFunctionType(type);
  if (fnType != null && !type.isEmptyType()) {
    if ((fnType.isConstructor() || fnType.isInterface()) && !fnType.equals(getNativeType(U2U_CONSTRUCTOR_TYPE))) {
      FunctionType superClassCtor=fnType.getSuperClassConstructor();
      ObjectType.Property prototypeSlot=fnType.getSlot("prototype");
      prototypeSlot.setNode(n);
      String prototypeName=variableName + ".prototype";
      Var prototypeVar=scopeToDeclareIn.getVar(prototypeName);
      if (prototypeVar != null && prototypeVar.scope == scopeToDeclareIn) {
        scopeToDeclareIn.undeclare(prototypeVar);
      }
      scopeToDeclareIn.declare(prototypeName,n,prototypeSlot.getType(),input,superClassCtor == null || superClassCtor.getInstanceType().equals(getNativeType(OBJECT_TYPE)));
      if (newVar.getInitialValue() == null && !isExtern && variableName.equals(fnType.getInstanceType().getReferenceName())) {
        compiler.report(JSError.make(sourceName,n,fnType.isConstructor() ? CTOR_INITIALIZER : IFACE_INITIALIZER,variableName));
      }
    }
  }
  if (shouldDeclareOnGlobalThis) {
    ObjectType globalThis=typeRegistry.getNativeObjectType(GLOBAL_THIS);
    if (inferred) {
      globalThis.defineInferredProperty(variableName,type == null ? getNativeType(JSTypeNative.NO_TYPE) : type,n);
    }
 else {
      globalThis.defineDeclaredProperty(variableName,type,n);
    }
  }
  if (isGlobalVar && "Window".equals(variableName) && type != null && type.isFunctionType() && type.isConstructor()) {
    FunctionType globalThisCtor=typeRegistry.getNativeObjectType(GLOBAL_THIS).getConstructor();
    globalThisCtor.getInstanceType().clearCachedValues();
    globalThisCtor.getPrototype().clearCachedValues();
    globalThisCtor.setPrototypeBasedOn((type.toMaybeFunctionType()).getInstanceType());
  }
}
