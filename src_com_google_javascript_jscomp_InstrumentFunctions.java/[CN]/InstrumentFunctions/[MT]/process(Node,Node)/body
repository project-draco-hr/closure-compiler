{
  Node initCode=null;
  if (!initCodeSource.isEmpty()) {
    Node initCodeRoot=compiler.parseSyntheticCode(templateFilename + ":init",initCodeSource);
    if (initCodeRoot != null && initCodeRoot.getFirstChild() != null) {
      initCode=initCodeRoot.removeChildren();
    }
 else {
      return;
    }
  }
  NodeTraversal.traverse(compiler,root,new RemoveCallback(declarationsToRemove));
  NodeTraversal.traverse(compiler,root,new InstrumentCallback());
  if (!appNameSetter.isEmpty()) {
    Node call=IR.call(IR.name(appNameSetter),IR.string(appNameStr));
    call.putBooleanProp(Node.FREE_CALL,true);
    Node expr=IR.exprResult(call);
    Node addingRoot=compiler.getNodeForCodeInsertion(null);
    addingRoot.addChildrenToFront(expr);
    compiler.reportCodeChange();
  }
  if (initCode != null) {
    Node addingRoot=compiler.getNodeForCodeInsertion(null);
    addingRoot.addChildrenToFront(initCode);
    compiler.reportCodeChange();
  }
}
