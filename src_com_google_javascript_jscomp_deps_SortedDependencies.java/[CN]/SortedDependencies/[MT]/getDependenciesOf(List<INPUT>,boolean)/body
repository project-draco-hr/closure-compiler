{
  Preconditions.checkArgument(inputs.containsAll(roots));
  Set<INPUT> included=Sets.newHashSet();
  Deque<INPUT> worklist=new ArrayDeque<>(roots);
  while (!worklist.isEmpty()) {
    INPUT current=worklist.pop();
    if (included.add(current)) {
      for (      String req : current.getRequires()) {
        INPUT dep=provideMap.get(req);
        if (dep != null) {
          worklist.add(dep);
        }
      }
    }
  }
  ImmutableList.Builder<INPUT> builder=ImmutableList.builder();
  for (  INPUT current : (sorted ? sortedList : inputs)) {
    if (included.contains(current)) {
      builder.add(current);
    }
  }
  return builder.build();
}
