{
  Deque<Node> workset=Lists.newLinkedList(nominaltypesByNode.keySet());
  int iterations=0;
  final int MAX_ITERATIONS=50000;
  workset_loop:   while (!workset.isEmpty()) {
    Preconditions.checkState(iterations < MAX_ITERATIONS);
    Node funNode=workset.removeFirst();
    RawNominalType rawNominalType=nominaltypesByNode.get(funNode);
    NominalType superClass=rawNominalType.getSuperClass();
    if (superClass != null && !superClass.isFinalized()) {
      workset.addLast(funNode);
      iterations++;
      continue workset_loop;
    }
    for (    NominalType superInterf : rawNominalType.getInterfaces()) {
      if (!superInterf.isFinalized()) {
        workset.addLast(funNode);
        iterations++;
        continue workset_loop;
      }
    }
    if (superClass != null) {
      Preconditions.checkState(superClass.isFinalized());
      for (      String pname : superClass.getAllPropsOfClass()) {
        PropertyDef propDef=propertyDefs.get(rawNominalType.getId(),pname);
        PropertyDef inheritedPropDef=propertyDefs.get(superClass.getId(),pname);
        if (inheritedPropDef != null && inheritedPropDef.methodScope != null) {
          DeclaredFunctionType propDeclType;
          if (propDef == null || propDef.methodScope == null) {
            propDeclType=inheritedPropDef.methodScope.getDeclaredType();
          }
 else {
            DeclaredFunctionType funDeclType=propDef.methodScope.getDeclaredType();
            DeclaredFunctionType inheritedFunDeclType=inheritedPropDef.methodScope.getDeclaredType();
            propDeclType=funDeclType.withTypeInfoFromSuper(inheritedFunDeclType);
            propDef.methodScope.setDeclaredType(propDeclType);
          }
          rawNominalType.addProtoProperty(pname,JSType.fromFunctionType(propDeclType.toFunctionType()));
        }
        JSType inheritedPropType=superClass.getPropDeclaredType(pname);
        if (inheritedPropType == null) {
          continue;
        }
        JSType localPropType=rawNominalType.getPropDeclaredType(pname);
        if (!localPropType.isSubtypeOf(inheritedPropType)) {
          warnings.add(JSError.make(propDef.defSite,INVALID_PROP_OVERRIDE,pname,inheritedPropType.toString(),localPropType.toString()));
        }
      }
    }
    for (    NominalType superInterf : rawNominalType.getInterfaces()) {
      for (      String pname : superInterf.getAllPropsOfInterface()) {
        PropertyDef inheritedPropDef=propertyDefs.get(superInterf.getId(),pname);
        JSType inheritedPropType=superInterf.getPropDeclaredType(pname);
        if (!rawNominalType.mayHaveProp(pname)) {
          warnings.add(JSError.make(inheritedPropDef.defSite,TypeValidator.INTERFACE_METHOD_NOT_IMPLEMENTED,pname,superInterf.toString(),rawNominalType.toString()));
          continue;
        }
        PropertyDef propDef=propertyDefs.get(rawNominalType.getId(),pname);
        JSType localPropType=rawNominalType.getPropDeclaredType(pname);
        if (localPropType != null && !localPropType.isSubtypeOf(inheritedPropType)) {
          warnings.add(JSError.make(propDef.defSite,INVALID_PROP_OVERRIDE,pname,inheritedPropType.toString(),localPropType.toString()));
        }
 else         if (rawNominalType.isClass()) {
          if (localPropType == null) {
            rawNominalType.addProtoProperty(pname,inheritedPropType);
          }
 else           if (propDef.methodScope != null) {
            DeclaredFunctionType propDeclType=propDef.methodScope.getDeclaredType();
            propDeclType=propDeclType.withTypeInfoFromSuper(inheritedPropDef.methodScope.getDeclaredType());
            propDef.methodScope.setDeclaredType(propDeclType);
            rawNominalType.addProtoProperty(pname,JSType.fromFunctionType(propDeclType.toFunctionType()));
          }
        }
      }
    }
    rawNominalType.finalizeNominalType();
  }
}
