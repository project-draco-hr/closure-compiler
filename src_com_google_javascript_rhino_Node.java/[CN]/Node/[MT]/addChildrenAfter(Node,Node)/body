{
  Preconditions.checkArgument(node == null || node.parent == this);
  for (Node child=children; child != null; child=child.next) {
    Preconditions.checkArgument(child.parent == null);
    child.parent=this;
  }
  Node lastSibling=children.getLastSibling();
  if (node != null) {
    Node oldNext=node.next;
    node.next=children;
    children.previous=node;
    lastSibling.next=oldNext;
    if (oldNext != null) {
      oldNext.previous=lastSibling;
    }
    if (node == last) {
      last=lastSibling;
    }
  }
 else {
    if (first != null) {
      lastSibling.next=first;
      first.previous=lastSibling;
    }
 else {
      last=lastSibling;
    }
    first=children;
  }
}
