{
  Traversal traversal=new Traversal();
  NodeTraversal.traverse(compiler,root,traversal);
  if (!traversal.hasErrors()) {
    List<AliasUsage> aliasWorkQueue=Lists.newArrayList(traversal.getAliasUsages());
    while (!aliasWorkQueue.isEmpty()) {
      List<AliasUsage> newQueue=Lists.newArrayList();
      for (      AliasUsage aliasUsage : aliasWorkQueue) {
        if (aliasUsage.referencesOtherAlias()) {
          newQueue.add(aliasUsage);
        }
 else {
          aliasUsage.applyAlias();
        }
      }
      if (newQueue.size() == aliasWorkQueue.size()) {
        Var cycleVar=newQueue.get(0).aliasVar;
        compiler.report(JSError.make(cycleVar.getNode(),GOOG_SCOPE_ALIAS_CYCLE,cycleVar.getName()));
        break;
      }
 else {
        aliasWorkQueue=newQueue;
      }
    }
    for (    Node aliasDefinition : traversal.getAliasDefinitionsInOrder()) {
      if (aliasDefinition.getParent().isVar() && aliasDefinition.getParent().hasOneChild()) {
        aliasDefinition.getParent().detachFromParent();
      }
 else {
        aliasDefinition.detachFromParent();
      }
    }
    for (    Node scopeCall : traversal.getScopeCalls()) {
      Node expressionWithScopeCall=scopeCall.getParent();
      Node scopeClosureBlock=scopeCall.getLastChild().getLastChild();
      scopeClosureBlock.detachFromParent();
      expressionWithScopeCall.getParent().replaceChild(expressionWithScopeCall,scopeClosureBlock);
      NodeUtil.tryMergeBlock(scopeClosureBlock);
    }
    if (traversal.getAliasUsages().size() > 0 || traversal.getAliasDefinitionsInOrder().size() > 0 || traversal.getScopeCalls().size() > 0) {
      compiler.reportCodeChange();
    }
  }
}
