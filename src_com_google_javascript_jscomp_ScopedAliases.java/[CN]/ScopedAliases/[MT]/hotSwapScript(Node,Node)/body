{
  Traversal traversal=new Traversal();
  NodeTraversal.traverse(compiler,root,traversal);
  if (!traversal.hasErrors()) {
    for (    AliasUsage aliasUsage : traversal.getAliasUsages()) {
      aliasUsage.applyAlias();
    }
    for (    Node aliasDefinition : traversal.getAliasDefinitionsInOrder()) {
      if (aliasDefinition.getParent().isVar() && aliasDefinition.getParent().hasOneChild()) {
        aliasDefinition.getParent().detachFromParent();
      }
 else {
        aliasDefinition.detachFromParent();
      }
    }
    for (    Node scopeCall : traversal.getScopeCalls()) {
      Node expressionWithScopeCall=scopeCall.getParent();
      Node scopeClosureBlock=scopeCall.getLastChild().getLastChild();
      scopeClosureBlock.detachFromParent();
      expressionWithScopeCall.getParent().replaceChild(expressionWithScopeCall,scopeClosureBlock);
      NodeUtil.tryMergeBlock(scopeClosureBlock);
    }
    if (traversal.getAliasUsages().size() > 0 || traversal.getAliasDefinitionsInOrder().size() > 0 || traversal.getScopeCalls().size() > 0) {
      compiler.reportCodeChange();
    }
  }
}
