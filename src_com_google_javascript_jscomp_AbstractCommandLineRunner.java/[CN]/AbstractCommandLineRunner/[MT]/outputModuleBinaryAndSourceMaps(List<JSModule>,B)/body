{
  parsedModuleWrappers=parseModuleWrappers(config.moduleWrapper,modules);
  maybeCreateDirsForPath(config.moduleOutputPathPrefix);
  Writer mapFileOut=null;
  if (!(shouldGenerateMapPerModule(options) || config.useJsonStreams)) {
    mapFileOut=fileNameToOutputWriter2(expandSourceMapPath(options,null));
  }
  for (  JSModule m : modules) {
    if (config.useJsonStreams) {
      this.filesToStreamOut.add(createJsonFileFromModule(m));
    }
 else {
      if (shouldGenerateMapPerModule(options)) {
        mapFileOut=fileNameToOutputWriter2(expandSourceMapPath(options,m));
      }
      try (Writer writer=fileNameToLegacyOutputWriter(getModuleOutputFileName(m))){
        if (options.sourceMapOutputPath != null) {
          compiler.getSourceMap().reset();
        }
        writeModuleOutput(writer,m);
        if (options.sourceMapOutputPath != null) {
          compiler.getSourceMap().appendTo(mapFileOut,m.getName());
        }
      }
       if (shouldGenerateMapPerModule(options) && mapFileOut != null) {
        mapFileOut.close();
        mapFileOut=null;
      }
    }
  }
  if (mapFileOut != null) {
    mapFileOut.close();
  }
}
