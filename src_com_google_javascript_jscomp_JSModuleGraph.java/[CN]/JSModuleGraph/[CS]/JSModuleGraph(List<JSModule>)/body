{
  modules=Sets.newHashSetWithExpectedSize(modulesInDepOrder.size());
  modulesByDepth=Lists.newArrayList();
  for (  JSModule module : modulesInDepOrder) {
    int depth=0;
    for (    JSModule dep : module.getDependencies()) {
      int depDepth=dep.getDepth();
      if (depDepth < 0) {
        throw new ModuleDependenceException(String.format("Modules not in dependency order: %s preceded %s",module.getName(),dep.getName()),module,dep);
      }
      depth=Math.max(depth,depDepth + 1);
    }
    module.setDepth(depth);
    modules.add(module);
    if (depth == modulesByDepth.size()) {
      modulesByDepth.add(new ArrayList<JSModule>());
    }
    modulesByDepth.get(depth).add(module);
  }
}
